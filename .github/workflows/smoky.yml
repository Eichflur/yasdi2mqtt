name: build

on:
  push:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOCKER_IMAGE: pkwagner/yasdi2mqtt
      DOCKER_PLATFORMS: linux/amd64,linux/arm64
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: QEMU setup
        uses: docker/setup-qemu-action@v1
      - name: Docker Buildx setup
        uses: docker/setup-buildx-action@v1
        with:
          version: latest
          install: true
      - name: Enable Docker experimental features
        if: success()
        run: |
          echo '{"experimental": true}' | sudo tee /etc/docker/daemon.json
          sudo systemctl restart docker
      - name: Build
        if: success()
        run: |
          TAGS="-t ${DOCKER_IMAGE}:latest -t elizabeth"
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            TAGS="$TAGS -t ${DOCKER_IMAGE}:stable"
            TAGS="$TAGS -t ${DOCKER_IMAGE}:${GITHUB_REF#refs/tags/v}"
          fi

          docker build \
            --platform $DOCKER_PLATFORMS \
            $TAGS \
            .
      - name: Set up smoke testing workbench
        if: success()
        uses: pkwagner/smoky-mqtt@v0.9
        with:
          ids: ${{env.DOCKER_PLATFORMS}}
          timeout: 60
          port: 8080
      - name: Fire up containers for smoke testing
        run: |
          for PLATFORM in ${DOCKER_PLATFORMS//,/ }; do
            docker run --rm -d --name ${PLATFORM////} --network=host --env-file .github/workflows/smoke-testing.env --platform $PLATFORM -e MQTT_PORT=8080 -e MQTT_USER=$PLATFORM elizabeth
          done
      - name: Shut down smoke testing containers
        if: always()
        run: |
          for PLATFORM in ${DOCKER_PLATFORMS//,/ }; do
            docker stop ${PLATFORM////}
          done
